sap.ui.define(                                                                                                                                                                                                                                                 
    ["sap/m/PDFViewer"],                                                                                                                                                                                                                                       
    function (PDFViewer) {                                                                                                                                                                                                                                     
        "use strict";                                                                                                                                                                                                                                          
        return sap.ui.controller("br.com.trescoracoes.cockpitdda.ext.controller.ListReportExt", {                                                                                                                                                              
                                                                                                                                                                                                                                                               
            /* ===================================================================&nbsp;                                                                                                                                                                       
                Impressão de boleto                                                                                                                                                                                                                            
            =================================================================== */                                                                                                                                                                             
            imprimirBoleto: function (oEvent) {                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                // Recupera a linha selecionada&nbsp;                                                                                                                                                                                                          
                var oSelection = this.extensionAPI.getSelectedContexts();                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                if (oSelection.length > 0) {                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                    var vBoleto = oSelection.reduce(function (sText, oSelectedContext) {                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                        return oSelectedContext.getObject();                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                    }, "");                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
debugger;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                // Chama PDF Viewer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                      
                var sServiceURL = "/sap/opu/odata/SAP/ZFI_BOLETO_DDA_SRV/";                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                var vSourceRead = "DownloadCheckSet(Lifnr='" + vBoleto.Supplier + "',Bukrs='" + vBoleto.CompanyCode +                                                                                                                                          
                    "',Belnr='" + vBoleto.DocNumber + "',Gjahr='" + vBoleto.FiscalYear + "',Barcode='" + vBoleto.Barcode +&nbsp;                                                                                                                               
                    "',DataArq='" + vBoleto.DataArq + "',NumDoc='" + vBoleto.ReferenceNo.trim() + "')";                                                                                                                                                        
                                                                                                                                                                                                                                                               
                var sSource = sServiceURL + "PdfFileSet(Lifnr='" + vBoleto.Supplier + "',Bukrs='" + vBoleto.CompanyCode +                                                                                                                                      
                    "',Belnr='" + vBoleto.DocNumber + "',Gjahr='" + vBoleto.FiscalYear + "',Barcode='" + vBoleto.Barcode +                                                                                                                                     
                    "',DataArq='" + vBoleto.DataArq + "',NumDoc='" + vBoleto.ReferenceNo.trim() + "')/$value";                                                                                                                                                 
                                                                                                                                                                                                                                                               
                var oModel = new sap.ui.model.odata.ODataModel(sServiceURL, false);                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                oModel.read(vSourceRead, null, null, true,                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                    /* ===================================================================&nbsp;                                                                                                                                                               
                    Em caso de sucesso, recupera arquivo                                                                                                                                                                                                       
                    =================================================================== */                                                                                                                                                                     
                    function (oData) {                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                        if (!oData.Value) {                                                                                                                                                                                                                    
                            return;                                                                                                                                                                                                                            
                        }                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                        //var oSource = sServiceUrl + "downloadSet(Docnum='" + oData.Docnum + "',Doctype='" + oData.Doctype + "')/$value";                                                                                                                     
                        var oPDFViewer = new PDFViewer();                                                                                                                                                                                                      
                        this.getView().addDependent(oPDFViewer);                                                                                                                                                                                               
                        oPDFViewer.setSource(sSource);                                                                                                                                                                                                         
                        oPDFViewer.setTitle("Boleto DDA");                                                                                                                                                                                                     
                        oPDFViewer.open();                                                                                                                                                                                                                     
                        //oPDFViewer.downloadPDF();                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                    }.bind(this),                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                    function (error) {                                                                                                                                                                                                                         
                        alert("Não foi possível gerar o boleto DDA.");                                                                                                                                                                                         
                        return;                                                                                                                                                                                                                                
                    }                                                                                                                                                                                                                                          
                );                                                                                                                                                                                                                                             
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            /* ===================================================================&nbsp;                                                                                                                                                                       
                Conciliação Manual                                                                                                                                                                                                                             
            =================================================================== */                                                                                                                                                                             
            conciliaManual: function (oEvent) {                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                var oSelection = this.extensionAPI.getSelectedContexts();                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                var tSupplier = []                                                                                                                                                                                                                             
                var tCompanyCode = []                                                                                                                                                                                                                          
                var tDocNumber = []                                                                                                                                                                                                                            
                var tFiscalYear = []                                                                                                                                                                                                                           
                var tReferenceNo = []                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                if (oSelection.length > 0) {                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                    for (var i = 0; i < oSelection.length; i++) {                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                        // var vBoleto = oSelection.reduce(function (sText, oSelectedContext) {                                                                                                                                                                
                                                                                                                                                                                                                                                               
                        //return oSelectedContext.getObject();                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                        //}, "");                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                        var vBoleto = oSelection[i].getObject();                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                        if (vBoleto.ErrorXblnr == 'X') {                                                                                                                                                                                                       
                            alert("Nota Fiscal Divergente, utilize o botão para conciliar!");                                                                                                                                                                  
                            return;                                                                                                                                                                                                                            
                        }                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                        if (vBoleto.ErrReason == '') {                                                                                                                                                                                                         
                            alert("Não é possível executar esta ação.");                                                                                                                                                                                       
                            return;                                                                                                                                                                                                                            
                        }                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                        if (vBoleto.Supplier != '') {                                                                                                                                                                                                          
                            tSupplier.push(vBoleto.Supplier);                                                                                                                                                                                                  
                        }                                                                                                                                                                                                                                      
                        if (vBoleto.CompanyCode != '') {                                                                                                                                                                                                       
                            tCompanyCode.push(vBoleto.CompanyCode);                                                                                                                                                                                            
                        }                                                                                                                                                                                                                                      
                        if (vBoleto.DocNumber != '') {                                                                                                                                                                                                         
                            tDocNumber.push(vBoleto.DocNumber);                                                                                                                                                                                                
                        } else if (vBoleto.ErrReason = 'V') {                                                                                                                                                                                                  
                            tReferenceNo.push(vBoleto.ReferenceNo);                                                                                                                                                                                            
                        }                                                                                                                                                                                                                                      
                        if (vBoleto.FiscalYear != '') {                                                                                                                                                                                                        
                            tFiscalYear.push(vBoleto.FiscalYear);                                                                                                                                                                                              
                        }                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                    }                                                                                                                                                                                                                                          
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Verifica se usuário tem permissão para navegação&nbsp;                                                                                                                                                                                         
                =================================================================== */                                                                                                                                                                         
                sap.ushell.Container.getService("CrossApplicationNavigation").isNavigationSupported([                                                                                                                                                          
                    { target: { shellHash: "conciliacaomanualdda-manage" } }                                                                                                                                                                                   
                ])                                                                                                                                                                                                                                             
                    .done(function (aResponse) {                                                                                                                                                                                                               
                        aResponse.map(function (elem, index) {                                                                                                                                                                                                 
                            if (elem.supported === true) {                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                                /* ===================================================================&nbsp;                                                                                                                                                   
                                Chama outro aplicativo                                                                                                                                                                                                         
                                =================================================================== */                                                                                                                                                         
                                var href_parameters = (sap.ushell && sap.ushell.Container &&                                                                                                                                                                   
                                    sap.ushell.Container.getService("CrossApplicationNavigation").hrefForExternal({                                                                                                                                            
                                        target: { semanticObject: "conciliacaomanualdda", action: "manage" },                                                                                                                                                  
                                        params: {                                                                                                                                                                                                              
                                            Supplier: tSupplier,                                                                                                                                                                                               
                                            CompanyCode: tCompanyCode,                                                                                                                                                                                         
                                            DocNumber: tDocNumber,                                                                                                                                                                                             
                                            FiscalYear: tFiscalYear,                                                                                                                                                                                           
                                            ReferenceNo: tReferenceNo                                                                                                                                                                                          
                                        }                                                                                                                                                                                                                      
                                    }));                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                                sap.m.URLHelper.redirect(href_parameters, false);                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                            }                                                                                                                                                                                                                                  
                            else {                                                                                                                                                                                                                             
                                alert('Usuário sem permissão para acessar o link');                                                                                                                                                                            
                            }                                                                                                                                                                                                                                  
                        })                                                                                                                                                                                                                                     
                    })                                                                                                                                                                                                                                         
                    .fail(function () {                                                                                                                                                                                                                        
                        alert('Falha ao acessar o link');                                                                                                                                                                                                      
                    });                                                                                                                                                                                                                                        
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
        });                                                                                                                                                                                                                                                    
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               