sap.ui.define([],                                                                                                                                                                                                                                              
    function () {                                                                                                                                                                                                                                              
        "use strict";                                                                                                                                                                                                                                          
        return {                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            oMsgDialog: undefined,                                                                                                                                                                                                                             
            aMessages: new Array(),                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
            sleep: function (milliseconds) {                                                                                                                                                                                                                   
                const date = Date.now();                                                                                                                                                                                                                       
                let currentDate = null;                                                                                                                                                                                                                        
                do {                                                                                                                                                                                                                                           
                    currentDate = Date.now();                                                                                                                                                                                                                  
                } while (currentDate - date < milliseconds);                                                                                                                                                                                                   
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onApprove: async function (oEvent) {                                                                                                                                                                                                               
                let oExtApi = this.templateBaseExtension.getExtensionAPI();                                                                                                                                                                                    
                this._approvePayment(oExtApi)                                                                                                                                                                                                                  
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            fetchMessage: function (oObject) {                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                if (oObject.dwdat != undefined || oObject.dwdat != null) {                                                                                                                                                                                     
                    this.aMessages.push({                                                                                                                                                                                                                      
                        type: sap.ui.core.MessageType.Warning,                                                                                                                                                                                                 
                        title: this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("DwDateSub").replace("&1", oObject.dwdat.toLocaleDateString()).replace("&2", oObject.dwusr),                                                              
                        description: this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("DwDateTitle"),                                                                                                                                     
                        subtitle: this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("DwDateDesc")                                                                                                                                          
                    });                                                                                                                                                                                                                                        
                }                                                                                                                                                                                                                                              
                if (oObject.NivelAtual == "1" )&nbsp;                                                                                                                                                                                                          
                {                                                                                                                                                                                                                                              
                    this.aMessages.push({                                                                                                                                                                                                                      
                        type: sap.ui.core.MessageType.Success,                                                                                                                                                                                                 
                        title: this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("ActionMessage"),                                                                                                                                         
                        description: this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("ActionTitle"),                                                                                                                                     
                        subtitle: this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("ActionSubEnc").replace("&1", oObject.CashPlanningGroup).replace("&2", oObject.NivelAtual).replace("&3", oObject.Username)                             
//subtitle: this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("ActionSub").replace("&1", oObject.CashPlanningGroup).replace("&2", oObject.NivelAtual).replace("&3", oObject.Username)                                                      
                    });                                                                                                                                                                                                                                        
                }                                                                                                                                                                                                                                              
                if (oObject.NivelAtual != "1" )&nbsp;                                                                                                                                                                                                          
                {                                                                                                                                                                                                                                              
                    var nivel = parseInt(oObject.NivelAtual);                                                                                                                                                                                                  
                    nivel = nivel - 1;                                                                                                                                                                                                                         
                    this.aMessages.push({                                                                                                                                                                                                                      
                        type: sap.ui.core.MessageType.Success,                                                                                                                                                                                                 
                        title: this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("ActionMessage"),                                                                                                                                         
                        description: this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("ActionTitle"),                                                                                                                                     
                        //subtitle: this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("ActionSubEnc").replace("&1", oObject.CashPlanningGroup).replace("&2", oObject.NivelAtual).replace("&3", oObject.Username)                           
                        subtitle: this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("ActionSub").replace("&1", oObject.CashPlanningGroup).replace("&2", nivel).replace("&3", oObject.Username)                                             
                    });                                                                                                                                                                                                                                        
                }                                                                                                                                                                                                                                              
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            _approvePayment: function (oExtApi) {                                                                                                                                                                                                              
                let aPromises = [];                                                                                                                                                                                                                            
                for (let oContext of oExtApi.getSelectedContexts()) {                                                                                                                                                                                          
                    let oObject = oContext.getObject();                                                                                                                                                                                                        
                    //let dDate = new Date(oObject.NetDueDate.getTime() + oObject.RunHourTo.ms + (new Date().getTimezoneOffset() * 60 * 1000));                                                                                                                
                    aPromises.push(new Promise(function (fnResolve, fnReject) {                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                        this.getView().getModel().callFunction("/approv", {                                                                                                                                                                                    
                            method: "POST",                                                                                                                                                                                                                    
                            //urlParameters: { CompanyCode: oObject.CompanyCode, NetDueDate: dDate.toLocaleDateString().split('/').reverse().join(''), RunHourTo: dDate.toLocaleTimeString().replaceAll(':', ''), RepType: oObject.RepType, CashPlanningGroup:+
 oObject.CashPlanningGroup },                                                                                                                                                                                                                                  
                            //urlParameters: { CompanyCode: oObject.CompanyCode, NetDueDate: oObject.NetDueDate.toLocaleDateString().split("/").reverse().join(""), RunHourTo: oObject.RunHourTo.toLocaleString(), RepType: oObject.RepType, CashPlanningGroup+
: oObject.CashPlanningGroup },                                                                                                                                                                                                                                 
                            urlParameters: { CompanyCode: oObject.CompanyCode, NetDueDate: oObject.NetDueDate.toISOString().slice(0,10).split("-").join(""), RunHourTo: oObject.RunHourTo.toLocaleString(), RepType: oObject.RepType, CashPlanningGroup: oObje+
ct.CashPlanningGroup },                                                                                                                                                                                                                                        
                            success: function (oData, response) {                                                                                                                                                                                              
                                this.getView().getModel().read("/ContasPagar('" + encodeURIComponent(oObject.ID) + "')", {                                                                                                                                     
                                    success: function (oData, response) {                                                                                                                                                                                      
                                        fnResolve(oData);                                                                                                                                                                                                      
                                    }                                                                                                                                                                                                                          
                                })                                                                                                                                                                                                                             
                            }.bind(this),                                                                                                                                                                                                                      
                            error: function (oError) {                                                                                                                                                                                                         
                                fnReject(oError);                                                                                                                                                                                                              
                            }                                                                                                                                                                                                                                  
                        });                                                                                                                                                                                                                                    
                    }.bind(this)))                                                                                                                                                                                                                             
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                for (let oPromise of aPromises) {                                                                                                                                                                                                              
                    oExtApi.securedExecution(oPromise.then(this.fetchMessage.bind(this))                                                                                                                                                                       
                        .then(oExtApi.refreshTable())                                                                                                                                                                                                          
                        .finally(this.showMessages.bind(this))                                                                                                                                                                                                 
                        .catch(                                                                                                                                                                                                                                
                            function (oError) {                                                                                                                                                                                                                
                                sap.m.MessageToast.show(oError)                                                                                                                                                                                                
                            }),                                                                                                                                                                                                                                
                        { busy: { set: true, check: true } });                                                                                                                                                                                                 
                }                                                                                                                                                                                                                                              
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            showMessages: function () {                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                let oMessageView = new sap.m.MessageView({                                                                                                                                                                                                     
                    showDetailsPageHeader: true,                                                                                                                                                                                                               
                    items: {                                                                                                                                                                                                                                   
                        path: "/",                                                                                                                                                                                                                             
                        template: new sap.m.MessageItem({                                                                                                                                                                                                      
                            type: "{type}",                                                                                                                                                                                                                    
                            title: "{title}",                                                                                                                                                                                                                  
                            description: "{description}",                                                                                                                                                                                                      
                            subtitle: "{subtitle}"                                                                                                                                                                                                             
                        })                                                                                                                                                                                                                                     
                    }                                                                                                                                                                                                                                          
                });                                                                                                                                                                                                                                            
                let oModel = new sap.ui.model.json.JSONModel();                                                                                                                                                                                                
                oModel.setData(this.aMessages);                                                                                                                                                                                                                
                oMessageView.setModel(oModel);                                                                                                                                                                                                                 
                this.oMsgDialog.destroyContent();                                                                                                                                                                                                              
                this.oMsgDialog.addContent(oMessageView);                                                                                                                                                                                                      
                this.oMsgDialog.open();                                                                                                                                                                                                                        
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onInit: function (oEvent) {                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                if (sap.ui.getCore().byId("idMsg"))                                                                                                                                                                                                            
                    sap.ui.getCore().byId("idMsg").destroy();                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                if (!this._sIdPrefix) {                                                                                                                                                                                                                        
                    this._sIdPrefix =                                                                                                                                                                                                                          
                        "br.com.trescoracoes.aprovctaspagar::sap.suite.ui.generic.template.ListReport.view.ListReport::ContasPagar--";                                                                                                                         
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                this.byId(this._sIdPrefix + "analyticalTable").getParent().setIgnoreFromPersonalisation("CompanyCodeName, SupplierFullName, CashPlanningGroupName, RepTypeText, encerradorcrit, aprov1crit, aprov2crit, aprov3crit," +                         
                    "encerradortext, aprov1text, aprov2text, aprov3text, Username, Userlevel, NivelAtual");                                                                                                                                                    
                                                                                                                                                                                                                                                               
                this.oMsgDialog = new sap.m.Dialog({                                                                                                                                                                                                           
                    resizable: true,                                                                                                                                                                                                                           
                    id: "idMsg",                                                                                                                                                                                                                               
                    type: "Message",                                                                                                                                                                                                                           
                    icon: "sap-icon://alert",                                                                                                                                                                                                                  
                    title: this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("MessageViewTitle"),                                                                                                                                          
                    state: "Information",                                                                                                                                                                                                                      
                    contentHeight: "50%",                                                                                                                                                                                                                      
                    contentWidth: "50%",                                                                                                                                                                                                                       
                    verticalScrolling: false,                                                                                                                                                                                                                  
                    beginButton: new sap.m.Button({                                                                                                                                                                                                            
                        press: function () {                                                                                                                                                                                                                   
                            this.aMessages = [];                                                                                                                                                                                                               
                            sap.ui.getCore().byId("idMsg").close();                                                                                                                                                                                            
                        }.bind(this),                                                                                                                                                                                                                          
                        text: "Close"                                                                                                                                                                                                                          
                    })                                                                                                                                                                                                                                         
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onAfterRendering: function (oEvent) {                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                let oContentTable = this.byId(this._sIdPrefix + "analyticalTable");                                                                                                                                                                            
                for (let oColumn of oContentTable.getColumns()) {                                                                                                                                                                                              
                    if (oColumn.getId().split('-').pop() == 'RunHourTo')                                                                                                                                                                                       
                        oColumn.setVisible(false);                                                                                                                                                                                                             
                }                                                                                                                                                                                                                                              
                oContentTable.attachBusyStateChanged(this._onBusyStateChanged);                                                                                                                                                                                
                oContentTable.getPlugins()[0].attachSelectionChange(this._onRowSelectionChanged, this);                                                                                                                                                        
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            _onRowSelectionChanged: function (oEvent) {                                                                                                                                                                                                        
                if (this.templateBaseExtension.getExtensionAPI().getSelectedContexts().length == 0)                                                                                                                                                            
                    this.byId("btnAprovButton").setEnabled(false);                                                                                                                                                                                             
                for (let oCtx of this.templateBaseExtension.getExtensionAPI().getSelectedContexts())                                                                                                                                                           
                    if (oCtx.getObject().Userlevel != oCtx.getObject().NivelAtual) {                                                                                                                                                                           
                        this.byId("btnAprovButton").setEnabled(false);                                                                                                                                                                                         
                        return;                                                                                                                                                                                                                                
                    } else {                                                                                                                                                                                                                                   
                        this.byId("btnAprovButton").setEnabled(true);                                                                                                                                                                                          
                    }                                                                                                                                                                                                                                          
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            _onBusyStateChanged: function (oEvent) {                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                let bBusy = oEvent.getParameter("busy");                                                                                                                                                                                                       
                if (!bBusy && !this._bColumnOptimizationDone) {                                                                                                                                                                                                
                    let oTable = oEvent.getSource();                                                                                                                                                                                                           
                    let oTpc = null;                                                                                                                                                                                                                           
                    if (sap.ui.table.TablePointerExtension) {                                                                                                                                                                                                  
                        oTpc = new sap.ui.table.TablePointerExtension(oTable);                                                                                                                                                                                 
                    } else {                                                                                                                                                                                                                                   
                        oTpc = new sap.ui.table.extensions.Pointer(oTable);                                                                                                                                                                                    
                    }                                                                                                                                                                                                                                          
                    let aColumns = oTable.getColumns();                                                                                                                                                                                                        
                    for (let i = 0; i < aColumns.length; i++) {                                                                                                                                                                                                
                        //oTpc.doAutoResizeColumn(i);                                                                                                                                                                                                          
                        if (aColumns[i].getId().split('-').pop() == 'RunHourTo')                                                                                                                                                                               
                            aColumns[i].setVisible(false);                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                    }                                                                                                                                                                                                                                          
                    //This line can be commented if you want the columns to be adjusted on every scroll                                                                                                                                                        
                    //this._bColumnOptimizationDone = true;                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onNavigate: function (oEvent) {                                                                                                                                                                                                                    
                let oExtApi = this.templateBaseExtension.getExtensionAPI();                                                                                                                                                                                    
                let oControl = oEvent.getSource();                                                                                                                                                                                                             
                this.getView().setBusy(true);                                                                                                                                                                                                                  
                for (let oCtx of oExtApi.getSelectedContexts()) {                                                                                                                                                                                              
                    this.getView().getModel().read("/URL(CompanyCode='" + encodeURIComponent(oCtx.getObject().CompanyCode) + "',NetDueDate=datetime'" + encodeURIComponent(new Date(oCtx.getObject().NetDueDate).toISOString().split(".")[0]) + "',CashPlannin+
gGroup='" + encodeURIComponent(oCtx.getObject().CashPlanningGroup) +                                                                                                                                                                                           
                        "',RepType='" + encodeURIComponent(oCtx.getObject().RepType) + "',Tipo='0',hbkid='',rzawe='',PaymentRunID='" + encodeURIComponent(oCtx.getObject().PaymentRunID) + "')",                                                               
                        {                                                                                                                                                                                                                                      
                            success: function (oData, response) {                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                                switch (oControl.getId().split("-").pop()) {                                                                                                                                                                                   
                                    case "btnPaidButton":                                                                                                                                                                                                      
                                        if (oData.PaymentDocument == "")                                                                                                                                                                                       
                                            sap.m.MessageBox.information(this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("PaymentError"));                                                                                               
                                        else                                                                                                                                                                                                                   
                                            sap.m.URLHelper.redirect(oData.PaymentDocument, true);                                                                                                                                                             
                                            window.location.reload();                                                                                                                                                                                          
                                        break;                                                                                                                                                                                                                 
                                    case "btnOpenButton":                                                                                                                                                                                                      
                                        if (oData.OpenDocument == "")                                                                                                                                                                                          
                                            sap.m.MessageBox.information(this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("OpenError"));                                                                                                  
                                        else&nbsp;                                                                                                                                                                                                             
                                            sap.m.URLHelper.redirect(oData.OpenDocument, true);                                                                                                                                                                
                                            window.location.reload();                                                                                                                                                                                          
                                        break;                                                                                                                                                                                                                 
                                    case "btnBlockedButton":                                                                                                                                                                                                   
                                        if (oData.BlockedDocument == "")                                                                                                                                                                                       
                                            sap.m.MessageBox.information(this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("BlockError"));                                                                                                 
                                        else                                                                                                                                                                                                                   
                                            sap.m.URLHelper.redirect(oData.BlockedDocument, true);                                                                                                                                                             
                                            window.location.reload();                                                                                                                                                                                          
                                        break;                                                                                                                                                                                                                 
                                    default:                                                                                                                                                                                                                   
                                        break;                                                                                                                                                                                                                 
                                }                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                            }.bind(this),                                                                                                                                                                                                                      
                            error: function (oError) {                                                                                                                                                                                                         
                                sap.m.MessageBox.error(oError.response);                                                                                                                                                                                       
                                wait(4000);                                                                                                                                                                                                                    
                                window.location.reload();                                                                                                                                                                                                      
                            }.bind(this)                                                                                                                                                                                                                       
                        });                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
        };                                                                                                                                                                                                                                                     
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               