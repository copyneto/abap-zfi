sap.ui.define([                                                                                                                                                                                                                                                
    "sap/ui/export/Spreadsheet",                                                                                                                                                                                                                               
    "sap/ui/core/util/Export",                                                                                                                                                                                                                                 
    "sap/ui/export/library",                                                                                                                                                                                                                                   
    "sap/ui/model/json/JSONModel",                                                                                                                                                                                                                             
    "sap/m/MessageToast",                                                                                                                                                                                                                                      
    "sap/m/MessageBox"&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                 
],                                                                                                                                                                                                                                                             
function (Spreadsheet, Export, exportLibrary, library,JSONModel, MessageToast, MessageBox) {                                                                                                                                                                   
    "use strict";                                                                                                                                                                                                                                              
    var EdmType = exportLibrary.EdmType;                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
    return sap.ui.controller("br.com.trescoracoes.cockpitagrupafaturas.ext.controller.ListReportExt", {                                                                                                                                                        
                                                                                                                                                                                                                                                               
        onOpenLog: function (oEvent) {                                                                                                                                                                                                                         
            var href = (sap.ushell && sap.ushell.Container &&                                                                                                                                                                                                  
                sap.ushell.Container.getService("CrossApplicationNavigation").hrefForExternal(                                                                                                                                                                 
                     {&nbsp;&nbsp;                                                                                                                                                                                                                             
                         target: { semanticObject: "logagrupafaturas", action: "display" }                                                                                                                                                                     
                     }                                                                                                                                                                                                                                         
                )                                                                                                                                                                                                                                              
            );                                                                                                                                                                                                                                                 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                       
             sap.m.URLHelper.redirect(href, true);                                                                                                                                                                                                             
         },&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
        onOpenParamForn: function (oEvent) {                                                                                                                                                                                                                   
            var href = (sap.ushell && sap.ushell.Container &&                                                                                                                                                                                                  
                sap.ushell.Container.getService("CrossApplicationNavigation").hrefForExternal(                                                                                                                                                                 
                    {&nbsp;&nbsp;                                                                                                                                                                                                                              
                        target: { semanticObject: "cadfornecedoragrupador", action: "maintain" }                                                                                                                                                               
                    }                                                                                                                                                                                                                                          
                )                                                                                                                                                                                                                                              
            );                                                                                                                                                                                                                                                 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                       
            sap.m.URLHelper.redirect(href, true);                                                                                                                                                                                                              
        },&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
        onUploadExcel: function (oEvent) {                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Cria Diálogo dinâmico (pop-up)                                                                                                                                                                                                                 
                =================================================================== */                                                                                                                                                                         
                var oUploadDialog = new sap.m.Dialog({                                                                                                                                                                                                         
                    contentWidth: "300px",                                                                                                                                                                                                                     
                    resizable: true,                                                                                                                                                                                                                           
                    type: "Message"                                                                                                                                                                                                                            
                });                                                                                                                                                                                                                                            
                oUploadDialog.setTitle("Carregar arquivo Excel");                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Define o serviço gateway que será chamado                                                                                                                                                                                                      
                =================================================================== */                                                                                                                                                                         
                var sServiceUrl = "/sap/opu/odata/SAP/ZFI_AGRUPA_FATURA_SRV/";                                                                                                                                                                                 
                var oModel = new sap.ui.model.odata.ODataModel(sServiceUrl, false);                                                                                                                                                                            
                var sSource = sServiceUrl + "ExcelSet";                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Prepara o responsável pela carga do arquivo                                                                                                                                                                                                    
                =================================================================== */                                                                                                                                                                         
                var oFileUploader = new sap.ui.unified.FileUploader({                                                                                                                                                                                          
                    width: "100%",                                                                                                                                                                                                                             
                    fileType: "xlsx",                                                                                                                                                                                                                          
                    style: "Emphasized",                                                                                                                                                                                                                       
                    uploadComplete: function (oEvent) {                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                        // Atualiza tabela do relatório após carga                                                                                                                                                                                             
                        var sId = this.oView.sId + '--responsiveTable';                                                                                                                                                                                        
                        var oTable = this.byId(sId);                                                                                                                                                                                                           
                        oTable.getModel().refresh(true);                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                        oUploadDialog.close();                                                                                                                                                                                                                 
                        oUploadDialog.destroy();                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                        // Verifica o retorno da mensagem                                                                                                                                                                                                      
                        if (oEvent.mParameters.status == '200' ||                                                                                                                                                                                              
                            oEvent.mParameters.status == '201') {                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                            sap.m.MessageToast.show("Carga realizada com sucesso.");                                                                                                                                                                           
                        } else {                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                            // Recupera texto da mensagem                                                                                                                                                                                                      
                            let aMessage = [];                                                                                                                                                                                                                 
                            for (const res of oEvent.mParameters.responseRaw.matchAll(/(?:<message>(.*?)<[/]message>)/gm)) {                                                                                                                                   
                                aMessage.push(res[1]);                                                                                                                                                                                                         
                            }                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                            // Recupera tipo da mensagem                                                                                                                                                                                                       
                            let aSeverity = [];                                                                                                                                                                                                                
                            for (const res of oEvent.mParameters.responseRaw.matchAll(/(?:<severity>(.*?)<[/]severity>)/gm)) {                                                                                                                                 
                                                                                                                                                                                                                                                               
                                switch (res[1]) {                                                                                                                                                                                                              
                                case "error":                                                                                                                                                                                                                  
                                    aSeverity.push(sap.ui.core.MessageType.Error);                                                                                                                                                                             
                                    break;                                                                                                                                                                                                                     
                                case "info":                                                                                                                                                                                                                   
                                    aSeverity.push(sap.ui.core.MessageType.Information);                                                                                                                                                                       
                                    break;                                                                                                                                                                                                                     
                                case "success":                                                                                                                                                                                                                
                                    aSeverity.push(sap.ui.core.MessageType.Success);                                                                                                                                                                           
                                    break;                                                                                                                                                                                                                     
                                case "warning":                                                                                                                                                                                                                
                                    aSeverity.push(sap.ui.core.MessageType.Warning);                                                                                                                                                                           
                                    break;                                                                                                                                                                                                                     
                                default:                                                                                                                                                                                                                       
                                    aSeverity.push(sap.ui.core.MessageType.None);                                                                                                                                                                              
                                    break;                                                                                                                                                                                                                     
                                }                                                                                                                                                                                                                              
                            }                                                                                                                                                                                                                                  
                            // Exibe mensagem                                                                                                                                                                                                                  
                            for (let i = 0; i < aMessage.length; i++) {                                                                                                                                                                                        
                                if (aMessage[i] == "Ocorreu uma exceção") {                                                                                                                                                                                    
                                    continue;                                                                                                                                                                                                                  
                                }                                                                                                                                                                                                                              
                                sap.ui.getCore().getMessageManager().addMessages(new sap.ui.core.message.Message({                                                                                                                                             
                                    message: aMessage[i],                                                                                                                                                                                                      
                                    persistent: true,                                                                                                                                                                                                          
                                    type: aSeverity[i] // create message as transition message                                                                                                                                                                 
                                }));                                                                                                                                                                                                                           
                                alert(aMessage[i]);                                                                                                                                                                                                            
                            }                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                   
                            // if (oEvent.mParameters.response) {                                                                                                                                                                                              
                            //     alert("Return Code: " + oEvent.mParameters.response, "Response", "Response");                                                                                                                                               
                            // }                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                       
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                        }                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                    }.bind(this)                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
               Define parâmetros                                                                                                                                                                                                                               
                =================================================================== */                                                                                                                                                                         
                oFileUploader.setName("Simple Uploader");                                                                                                                                                                                                      
                oFileUploader.setUploadUrl(sSource);                                                                                                                                                                                                           
                oFileUploader.setSendXHR(true);                                                                                                                                                                                                                
                oFileUploader.setUseMultipart(false);                                                                                                                                                                                                          
                oFileUploader.setUploadOnChange(false);                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                var oToken = new sap.ui.unified.FileUploaderParameter({                                                                                                                                                                                        
                    name: "x-csrf-token",                                                                                                                                                                                                                      
                    value: oModel.getSecurityToken()                                                                                                                                                                                                           
                });                                                                                                                                                                                                                                            
                oFileUploader.insertHeaderParameter(oToken);                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Cria botão para a carga do arquivo                                                                                                                                                                                                             
                =================================================================== */                                                                                                                                                                         
                var oTriggerButton = new sap.m.Button({                                                                                                                                                                                                        
                    text: 'Upload',                                                                                                                                                                                                                            
                    type: 'Accept',                                                                                                                                                                                                                            
                    press: function () {                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                        // Verifica se arquivo foi informado                                                                                                                                                                                                   
                        var domRef = oFileUploader.getFocusDomRef();                                                                                                                                                                                           
                        var file = domRef.files[0];                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                        if (oFileUploader.getValue() === '') {                                                                                                                                                                                                 
                            sap.m.MessageToast.show("Favor selecionar um arquivo");                                                                                                                                                                            
                            return;                                                                                                                                                                                                                            
                        }                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                        var oContentType = new sap.ui.unified.FileUploaderParameter({                                                                                                                                                                          
                            name: "Content-Type",                                                                                                                                                                                                              
                            value: file.type                                                                                                                                                                                                                   
                        });                                                                                                                                                                                                                                    
                        oFileUploader.insertHeaderParameter(oContentType);                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        oFileUploader.insertHeaderParameter(new sap.ui.unified.FileUploaderParameter({                                                                                                                                                         
                            name: "SLUG",                                                                                                                                                                                                                      
                            value: oFileUploader.getValue()                                                                                                                                                                                                    
                        }));                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                        oFileUploader.upload();                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                    }.bind(this)                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Cria botão de cancelar                                                                                                                                                                                                                         
                =================================================================== */                                                                                                                                                                         
                var oCancelButton = new sap.m.Button({                                                                                                                                                                                                         
                    text: 'Cancelar',                                                                                                                                                                                                                          
                    type: 'Reject',                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                    press: function () {                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                        oUploadDialog.close();                                                                                                                                                                                                                 
                        oUploadDialog.destroy();                                                                                                                                                                                                               
                        this.getView().removeAllDependents();                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                    }.bind(this)                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Chama diálogo com a lógica de carga&nbsp;                                                                                                                                                                                                      
                =================================================================== */                                                                                                                                                                         
                oUploadDialog.addContent(oFileUploader);                                                                                                                                                                                                       
                oUploadDialog.setBeginButton(oCancelButton);                                                                                                                                                                                                   
                oUploadDialog.setEndButton(oTriggerButton);                                                                                                                                                                                                    
                oUploadDialog.open();                                                                                                                                                                                                                          
        }                                                                                                                                                                                                                                                      
    });                                                                                                                                                                                                                                                        
});                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               