sap.ui.define(["sap/m/PDFViewer"],                                                                                                                                                                                                                             
    function (PDFViewer) {                                                                                                                                                                                                                                     
        "use strict";                                                                                                                                                                                                                                          
        return {                                                                                                                                                                                                                                               
            /* onActionDownload: function (oEvent) { */                                                                                                                                                                                                        
                onPDFViewer: function (oEvent) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Recupa referência à tabela do relatório                                                                                                                                                                                                        
                =================================================================== */                                                                                                                                                                         
                var oItems = sap.ui.getCore().byId(this.oView.sId + '--responsiveTable').getSelectedItems();                                                                                                                                                   
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Verifica se alguma linha foi selecionada                                                                                                                                                                                                       
                =================================================================== */                                                                                                                                                                         
                if (!oItems.length) {                                                                                                                                                                                                                          
                    sap.m.MessageToast.show("Nenhum registro selecionado.");                                                                                                                                                                                   
                    return;                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Cria Diálogo dinâmico (pop-up)                                                                                                                                                                                                                 
                =================================================================== */                                                                                                                                                                         
                var oUploadDialog = new sap.m.Dialog({                                                                                                                                                                                                         
                    contentWidth: "300px",                                                                                                                                                                                                                     
                    resizable: true,                                                                                                                                                                                                                           
                    type: "Message"                                                                                                                                                                                                                            
                });                                                                                                                                                                                                                                            
                oUploadDialog.setTitle("Download");                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Texto do Pop-up                                                                                                                                                                                                                                
                =================================================================== */                                                                                                                                                                         
                if( oItems.length == 1 ){                                                                                                                                                                                                                      
                    var oText = new sap.m.Text({ text: "Deseja baixar o boleto selecionado?" });                                                                                                                                                               
                }else{                                                                                                                                                                                                                                         
                    var oText = new sap.m.Text({ text: "Deseja baixar os boletos dos " + oItems.length + " documentos selecionados?" });                                                                                                                       
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Cria botão para a carga do arquivo                                                                                                                                                                                                             
                =================================================================== */                                                                                                                                                                         
                var oTriggerButton = new sap.m.Button({                                                                                                                                                                                                        
                    text: 'Baixar',                                                                                                                                                                                                                            
                    type: 'Accept',                                                                                                                                                                                                                            
                    press: function () {                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                        oUploadDialog.close();                                                                                                                                                                                                                 
                        oUploadDialog.destroy();                                                                                                                                                                                                               
                        this.getView().removeAllDependents();                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                        var oServiceUrl = "/sap/opu/odata/SAP/ZFI_BOLETO_SRV/";                                                                                                                                                                                
                        //var oModel = new sap.ui.model.odata.ODataModel(oServiceUrl,  false);                                                                                                                                                                 
                        var oModel = new sap.ui.model.odata.ODataModel(oServiceUrl,  {                                                                                                                                                                         
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                       
                        });                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                        /* ===================================================================&nbsp;                                                                                                                                                           
                        Recupera PDFs das linhas selecionadas                                                                                                                                                                                                  
                        =================================================================== */                                                                                                                                                                 
                        //var oItems1 = sap.ui.getCore().byId(this.oView.sId + '--responsiveTable').getSelectedItems();                                                                                                                                        
                        //var oPDFViewer = new PDFViewer();                                                                                                                                                                                                    
                        //this.getView().addDependent(oPDFViewer);                                                                                                                                                                                             
                        for (let i = 0; i < oItems.length; i++) {                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                            //for (let vDoctype = 1; vDoctype <= 4; vDoctype++) {                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                                var oObject = oItems[i].getBindingContext().getObject();                                                                                                                                                                       
                                /* var vSourceRead = "downloadCheckSet(Docnum='" + oObject.Docnum + "',Doctype='" + vDoctype + "')" */                                                                                                                         
                                                                                                                                                                                                                                                               
                                var oSource = oServiceUrl + "pdfSet(Empresa='" + oObject.Empresa + "',Documento='" + oObject.Documento + "',Ano='" + oObject.Ano + "',Item='" + oObject.Item + "')/$value";                                                    
                                var oPDFViewer = new PDFViewer();                                                                                                                                                                                              
                                //this.getView().addDependent(oPDFViewer);                                                                                                                                                                                     
                                oPDFViewer.setSource(oSource);                                                                                                                                                                                                 
                                oPDFViewer.downloadPDF();                                                                                                                                                                                                      
                                /*oPDFViewer.destroy();*/                                                                                                                                                                                                      
                                //oPDFViewer.open();                                                                                                                                                                                                           
                                //oModel.read(vSourceRead, null, null, true,                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                                    /* ===================================================================&nbsp;                                                                                                                                               
                                    Em caso de sucesso, recupera arquivo                                                                                                                                                                                       
                                    =================================================================== */                                                                                                                                                     
                                /*                                                                                                                                                                                                                             
                                    function (oData) {                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                                        if (!oData.Value) {                                                                                                                                                                                                    
                                            return;                                                                                                                                                                                                            
                                        }                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                                        //sap.ui.core.util.File.save(oData.Value, 'device', 'pdf', 'application/pdf', 'utf-8', false);                                                                                                                         
                                        //var oSource = oServiceUrl + "downloadSet(Docnum='" + oData.Docnum + "',Doctype='" + oData.Doctype + "')/$value";                                                                                                     
                                        var oSource = sServiceURL + "pdfSet(Empresa='" + oObject.Empresa + "',Documento='" + oObject.Documento + "',Ano='" + oObject.Ano + "',Item='" + oObject.Item + "')/$value";                                            
                                        var oPDFViewer = new PDFViewer();                                                                                                                                                                                      
                                        this.getView().addDependent(oPDFViewer);                                                                                                                                                                               
                                        oPDFViewer.setSource(oSource);                                                                                                                                                                                         
                                        oPDFViewer.downloadPDF();                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                                    }.bind(this),                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                                    function (error) {                                                                                                                                                                                                         
                                    }); */                                                                                                                                                                                                                     
                           // }                                                                                                                                                                                                                                
                        }                                                                                                                                                                                                                                      
                        sap.ui.getCore().byId(this.oView.sId + '--responsiveTable').getModel().refresh(true);                                                                                                                                                  
                    }.bind(this)                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Cria botão de cancelar                                                                                                                                                                                                                         
                =================================================================== */                                                                                                                                                                         
                var oCancelButton = new sap.m.Button({                                                                                                                                                                                                         
                    text: 'Cancelar',                                                                                                                                                                                                                          
                    type: 'Reject',                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                    press: function () {                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                        oUploadDialog.close();                                                                                                                                                                                                                 
                        oUploadDialog.destroy();                                                                                                                                                                                                               
                        this.getView().removeAllDependents();                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                    }.bind(this)                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Chama diálogo com a lógica de carga&nbsp;                                                                                                                                                                                                      
                =================================================================== */                                                                                                                                                                         
                oUploadDialog.addContent(oText);                                                                                                                                                                                                               
                oUploadDialog.setBeginButton(oCancelButton);                                                                                                                                                                                                   
                oUploadDialog.setEndButton(oTriggerButton);                                                                                                                                                                                                    
                oUploadDialog.open();                                                                                                                                                                                                                          
                sap.ui.getCore().byId(this.oView.sId + '--responsiveTable').getModel().refresh(true);                                                                                                                                                          
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onPopup: function (oEvent) {                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                this.oDialog = new sap.m.Dialog({                                                                                                                                                                                                              
                    id: "pop-up",                                                                                                                                                                                                                              
                    resizable: true,                                                                                                                                                                                                                           
                    content: [                                                                                                                                                                                                                                 
                        new sap.m.Label({ text: "Email" }),                                                                                                                                                                                                    
                        new sap.m.Input({                                                                                                                                                                                                                      
                            type: "Email",                                                                                                                                                                                                                     
                            valueStateText: "E-mail deve ser válido.",                                                                                                                                                                                         
                            maxLength: 100,                                                                                                                                                                                                                    
                            id: "inEmail"                                                                                                                                                                                                                      
                        }),                                                                                                                                                                                                                                    
                    ],                                                                                                                                                                                                                                         
                    contentHeight: "30%",                                                                                                                                                                                                                      
                    contentWidth: "30%",                                                                                                                                                                                                                       
                    verticalScrolling: false,                                                                                                                                                                                                                  
                    beginButton: new sap.m.Button({                                                                                                                                                                                                            
                        press: function (oEvent) {                                                                                                                                                                                                             
                            this.onEmail(oEvent);                                                                                                                                                                                                              
                        }.bind(this),                                                                                                                                                                                                                          
                        text: "Enviar"                                                                                                                                                                                                                         
                    }),                                                                                                                                                                                                                                        
                    endButton: new sap.m.Button({                                                                                                                                                                                                              
                        press: function () {                                                                                                                                                                                                                   
                            this.getParent().close();                                                                                                                                                                                                          
                            this.getParent().destroy();                                                                                                                                                                                                        
                        },                                                                                                                                                                                                                                     
                        text: "Cancelar"                                                                                                                                                                                                                       
                    }),                                                                                                                                                                                                                                        
                    customHeader: new sap.m.Bar({                                                                                                                                                                                                              
                        contentMiddle: [                                                                                                                                                                                                                       
                            new sap.m.Text({ text: "Enviar email" })                                                                                                                                                                                           
                        ],                                                                                                                                                                                                                                     
                    })                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                this.oDialog.open();                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            onEmail: function (oEvent) {                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                var oModel = this.getOwnerComponent().getModel()                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                // Create a JSON model from an object literal                                                                                                                                                                                                  
                var popUp = new sap.ui.model.json.JSONModel({                                                                                                                                                                                                  
                    Key: "",                                                                                                                                                                                                                                   
                    Email: "",                                                                                                                                                                                                                                 
                    Mensagem: ""                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                // Assign the model object to the SAPUI5 core                                                                                                                                                                                                  
                sap.ui.getCore().setModel(popUp, "pop-up");                                                                                                                                                                                                    
                //this.getView().setModel(popUp, "pop-up");                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                var oEntry = {};                                                                                                                                                                                                                               
                oEntry = sap.ui.getCore().getModel("pop-up").getData()                                                                                                                                                                                         
                oEntry.Email = sap.ui.getCore().byId("inEmail").getValue();                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                var oSelection = this.extensionAPI.getSelectedContexts();                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                if (oSelection.length > 0) {                                                                                                                                                                                                                   
                    var vNome = oSelection.reduce(function (sText, oSelectedContext) {                                                                                                                                                                         
                        var mSelectedData = oSelectedContext.getObject();                                                                                                                                                                                      
                        return sText + mSelectedData.Empresa + mSelectedData.Documento + mSelectedData.Ano + mSelectedData.Item + ';';                                                                                                                         
                    }, "");                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Chama PDF Viewer com o link da URL                                                                                                                                                                                                             
                =================================================================== */                                                                                                                                                                         
                var vServiceURL = "/sap/opu/odata/SAP/ZFI_BOLETO_SRV/";                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                var oModelService = new sap.ui.model.odata.ODataModel(vServiceURL, false);                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                var vServiceUrlRead = "emailSet(Key='" +&nbsp;                                                                                                                                                                                                 
                                      vNome +&nbsp;                                                                                                                                                                                                            
                                      "',Email='" +                                                                                                                                                                                                            
                                      oEntry.Email +                                                                                                                                                                                                           
                                      "')";                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                oModelService.read(vServiceUrlRead, null, null, true,                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    /* ===================================================================&nbsp;                                                                                                                                                               
                    Em caso de sucesso,&nbsp;                                                                                                                                                                                                                  
                    =================================================================== */                                                                                                                                                                     
                    function (oData) {                                                                                                                                                                                                                         
                        sap.m.MessageBox.success(oData.Mensagem);                                                                                                                                                                                              
                        //sap.m.MessageToast.show(oData.Mensagem);                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                    }.bind(this),                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                    function (error) {                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                        if (error.response.body.search("<message>")) {                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                            var sResponse = error.response.body.split("<message>")[1].split("</message>")[0];                                                                                                                                                  
                                                                                                                                                                                                                                                               
                            alert(sResponse);                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                        }                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                        else {                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                            alert('Falha ao enviar email');                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                        }                                                                                                                                                                                                                                      
                    });                                                                                                                                                                                                                                        
                this.oDialog.close();                                                                                                                                                                                                                          
                this.oDialog.destroy();                                                                                                                                                                                                                        
            }                                                                                                                                                                                                                                                  
        };                                                                                                                                                                                                                                                     
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               