sap.ui.define(                                                                                                                                                                                                                                                 
    [                                                                                                                                                                                                                                                          
        "sap/m/VBox",                                                                                                                                                                                                                                          
        "sap/m/RadioButtonGroup",                                                                                                                                                                                                                              
        "sap/m/RadioButton",                                                                                                                                                                                                                                   
        "sap/m/Label",                                                                                                                                                                                                                                         
        "sap/ui/core/util/File"                                                                                                                                                                                                                                
    ],                                                                                                                                                                                                                                                         
    function (VBox, RadioButtonGroup, RadioButton, Label, File) {                                                                                                                                                                                              
        "use strict";                                                                                                                                                                                                                                          
        return {                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            GetRadioButtonGroup: function () {                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                 Cria Radio Button Group Dinamico                                                                                                                                                                                                              
                =================================================================== */                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                this.RadioButtonGroup = new VBox({                                                                                                                                                                                                             
                    items: [                                                                                                                                                                                                                                   
                        new Label({                                                                                                                                                                                                                            
                            labelFor: "RBG-Anexo",                                                                                                                                                                                                             
                            text: "Selecione o Tipo de Anexo do Documento:"                                                                                                                                                                                    
                        }),                                                                                                                                                                                                                                    
                        this.oRadionGroup = new RadioButtonGroup("RBG-Anexo", {                                                                                                                                                                                
                            selectedIndex: 2,                                                                                                                                                                                                                  
                            buttons: [                                                                                                                                                                                                                         
                                new RadioButton({ text: "Contrato Assinado" }),                                                                                                                                                                                
                                new RadioButton({ text: "Minuta" }),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
                                new RadioButton({ text: "Outros" }),                                                                                                                                                                                           
                                new RadioButton({ text: "Parecer"})                                                                                                                                                                                            
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                               
                            ]                                                                                                                                                                                                                                  
                        })                                                                                                                                                                                                                                     
                    ]                                                                                                                                                                                                                                          
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                this.RadioButtonGroup.addStyleClass("sapUiMediumMarginTop");                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                return this.RadioButtonGroup;                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onAnexar: function (oEvent) {                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                let oTable = oEvent.getSource().getParent().getParent();                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                 Cria Dialogo dinamico (pop-up)                                                                                                                                                                                                                
                =================================================================== */                                                                                                                                                                         
                var oUploadDialog = new sap.m.Dialog({                                                                                                                                                                                                         
                    contentWidth: "300px",                                                                                                                                                                                                                     
                    resizable: true,                                                                                                                                                                                                                           
                    type: "Message"                                                                                                                                                                                                                            
                });                                                                                                                                                                                                                                            
                oUploadDialog.setTitle("Carregar arquivo");                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Define o servico gateway que ser chamado                                                                                                                                                                                                       
                =================================================================== */                                                                                                                                                                         
                var sServiceUrl = "/sap/opu/odata/SAP/ZFI_CARGA_CONTRATO_CLIENTE_SRV/";                                                                                                                                                                        
                var oModel = new sap.ui.model.odata.ODataModel(sServiceUrl, false);                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Prepara o responsavel pela carga do arquivo                                                                                                                                                                                                    
                =================================================================== */                                                                                                                                                                         
                var oFileUploader = new sap.ui.unified.FileUploader({                                                                                                                                                                                          
                    width: "100%",                                                                                                                                                                                                                             
                    uploadComplete: function (oEvent) {                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                        // Atualiza tabela do relatorio apos carga                                                                                                                                                                                             
                        oTable.getModel().refresh(true);                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                        oUploadDialog.close();                                                                                                                                                                                                                 
                        oUploadDialog.destroy();                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                        // Verifica o retorno da mensagem                                                                                                                                                                                                      
                        if (oEvent.mParameters.status == '200' ||                                                                                                                                                                                              
                            oEvent.mParameters.status == '201' ||                                                                                                                                                                                              
                            oEvent.mParameters.status == '204') {                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                            sap.m.MessageToast.show("Carga realizada com sucesso.");                                                                                                                                                                           
                        }                                                                                                                                                                                                                                      
                        else {                                                                                                                                                                                                                                 
                            alert("Return Code: " + oEvent.mParameters.response, "Response", "Response");                                                                                                                                                      
                        }                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                    }.bind(this)                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Define parametros de Header                                                                                                                                                                                                                    
                =================================================================== */                                                                                                                                                                         
                oFileUploader.setName("Simple Uploader");                                                                                                                                                                                                      
                //oFileUploader.setUploadUrl(sSource);                                                                                                                                                                                                         
                oFileUploader.setSendXHR(true);                                                                                                                                                                                                                
                oFileUploader.setUseMultipart(false);                                                                                                                                                                                                          
                oFileUploader.setUploadOnChange(false);                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                var oToken = new sap.ui.unified.FileUploaderParameter({                                                                                                                                                                                        
                    name: "x-csrf-token",                                                                                                                                                                                                                      
                    value: oModel.getSecurityToken()                                                                                                                                                                                                           
                });                                                                                                                                                                                                                                            
                oFileUploader.insertHeaderParameter(oToken);                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Cria botao para a carga do arquivo                                                                                                                                                                                                             
                =================================================================== */                                                                                                                                                                         
                var oTriggerButton = new sap.m.Button({                                                                                                                                                                                                        
                    text: 'Upload',                                                                                                                                                                                                                            
                    type: 'Accept',                                                                                                                                                                                                                            
                    press: function () {                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                        var sBaseKey = this.templateBaseExtension.getExtensionAPI().getNavigationController().getCurrentKeys()[1];                                                                                                                             
                        var sSource = `${sServiceUrl}Arquivos(DocUuidH=${sBaseKey},TipoDoc='${this.oRadionGroup.getSelectedIndex() + 1}')/Upload`;                                                                                                             
                                                                                                                                                                                                                                                               
                        oFileUploader.setUploadUrl(sSource);                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                        // Verifica se arquivo foi informado                                                                                                                                                                                                   
                        var domRef = oFileUploader.getFocusDomRef();                                                                                                                                                                                           
                        var file = domRef.files[0];                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                        if (oFileUploader.getValue() === '') {                                                                                                                                                                                                 
                            sap.m.MessageToast.show("Favor selecionar um arquivo");                                                                                                                                                                            
                            return;                                                                                                                                                                                                                            
                        }                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                        var oContentType = new sap.ui.unified.FileUploaderParameter({                                                                                                                                                                          
                            name: "Content-Type",                                                                                                                                                                                                              
                            value: file.type                                                                                                                                                                                                                   
                        });                                                                                                                                                                                                                                    
                        oFileUploader.insertHeaderParameter(oContentType);                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        oFileUploader.insertHeaderParameter(new sap.ui.unified.FileUploaderParameter({                                                                                                                                                         
                            name: "SLUG",                                                                                                                                                                                                                      
                            value: oFileUploader.getValue()                                                                                                                                                                                                    
                        }));                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                        oFileUploader.upload();                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                    }.bind(this)                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Cria botï¿½o de cancelar                                                                                                                                                                                                                         
                =================================================================== */                                                                                                                                                                         
                var oCancelButton = new sap.m.Button({                                                                                                                                                                                                         
                    text: 'Cancelar',                                                                                                                                                                                                                          
                    type: 'Reject',                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                    press: function () {                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                        oUploadDialog.close();                                                                                                                                                                                                                 
                        oUploadDialog.destroy();                                                                                                                                                                                                               
                        this.getView().removeAllDependents();                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                    }.bind(this)                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Chama dialogo com a logica de carga&nbsp;                                                                                                                                                                                                      
                =================================================================== */                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                oUploadDialog.addContent(oFileUploader);                                                                                                                                                                                                       
                oUploadDialog.addContent(this.GetRadioButtonGroup());                                                                                                                                                                                          
                oUploadDialog.setBeginButton(oCancelButton);                                                                                                                                                                                                   
                oUploadDialog.setEndButton(oTriggerButton);                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                oUploadDialog.open();                                                                                                                                                                                                                          
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onDownload: function (oEvent) {                                                                                                                                                                                                                    
                var sServiceUrl = "/sap/opu/odata/SAP/ZFI_CARGA_CONTRATO_CLIENTE_SRV/";                                                                                                                                                                        
                var oModel = new sap.ui.model.odata.ODataModel(sServiceUrl);                                                                                                                                                                                   
                var oContext = oEvent.getSource().getParent().getParent().getSelectedContexts()[0].sPath;                                                                                                                                                      
                var sUrl = oContext.replace("ZC_FI_ANEXOS", "Download");                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                oModel.read(sUrl, {                                                                                                                                                                                                                            
                    success: function (data) {                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                        let sFileName = "";                                                                                                                                                                                                                    
                        let sFileExtension = "";                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                        let lastIndex = data.Filename.lastIndexOf('.');                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                        sFileName = data.Filename.substr(0, lastIndex);                                                                                                                                                                                        
                        sFileExtension = data.Filename.substr(lastIndex+1);                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                        let fContent = atob(data.Value);                                                                                                                                                                                                       
                        var byteNumbers = new Array(fContent.length);                                                                                                                                                                                          
                        for (let index = 0; index < fContent.length; index++) {                                                                                                                                                                                
                            byteNumbers[index] = fContent.charCodeAt(index)                                                                                                                                                                                    
                        }                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                        var byteArray = new Uint8Array(byteNumbers)                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                        sap.ui.core.util.File.save(byteArray, sFileName, sFileExtension, data.Mimetype);                                                                                                                                                       
                                                                                                                                                                                                                                                               
                    }                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
        };                                                                                                                                                                                                                                                     
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               